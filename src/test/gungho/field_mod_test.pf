!-----------------------------------------------------------------------------
! (c) The copyright relating to this work is owned jointly by the Crown, 
! Met Office and NERC 2014. 
! However, it has been created with the help of the GungHo Consortium, 
! whose members are identified at https://puma.nerc.ac.uk/trac/GungHo/wiki
!-----------------------------------------------------------------------------

!> Test the field representation
!>
module field_mod_test

  implicit none 

contains

  !> Ensure constructor and getters work.
  !>
  @test
  subroutine test_field_data( )

    use field_mod,               only : field_type,      &
                                        field_proxy_type 
    use function_space_mod,      only : function_space_type, V0
    use constants_mod, only : dp
    use mesh_mod, only : num_cells, v_unique_dofs
    use gaussian_quadrature_mod, only : gaussian_quadrature_type, &
                                        ngp_h, ngp_v
    use basis_function_mod,         only : v0_basis, &
                                           v0_diff_basis, &
                                           v0_nodal_coords
    use dofmap_mod,                 only : v0_dofmap
    use pFUnit_Mod

    implicit none

    type( function_space_type )      :: func_space
    type( field_type )               :: f_field
    type( field_proxy_type )         :: f_field_proxy
    type( gaussian_quadrature_type ) :: gq
    integer                          :: num_layers,num_dofs,num_unique_dofs
    integer                          :: testncell,       &
                                        testnlayers
    integer :: i,j, fs

    num_layers=50
    num_cells = 35
    num_dofs=4
    num_unique_dofs = 100
    do i=1,4
      v_unique_dofs(i,1)=num_unique_dofs
      v_unique_dofs(i,2)=num_dofs
    enddo
    allocate(v0_basis(1,v_unique_dofs(1,2),ngp_h,ngp_v))
    allocate(v0_diff_basis(3,v_unique_dofs(1,2),ngp_h,ngp_v))
    allocate(v0_nodal_coords(3,v_unique_dofs(1,2)))
    v0_basis=sqrt(2.0)
    v0_diff_basis=atan(4.0)
    v0_nodal_coords(1,:)=0.152689632_dp
    v0_nodal_coords(2,:)=0.562554751_dp
    v0_nodal_coords(3,:)=-0.8234_dp
    allocate( v0_dofmap(0:num_cells,v_unique_dofs(1,2)) )
    do i=0,num_cells
       v0_dofmap(i,:) = i+64
    end do

    f_field = field_type( vector_space = func_space%get_instance(V0), &
                          gq = gq%get_instance(),    &
                          num_layers = num_layers)

    f_field_proxy = f_field % get_proxy( )

    ! test the procedures of the type
    testncell = f_field_proxy%ncell
    @assertEqual( num_cells, testncell )

    testnlayers = f_field_proxy%nlayers
    @assertEqual( num_layers, testnlayers )

    fs = f_field%which_function_space()
    @assertEqual(fs,V0)

    deallocate(v0_basis)
    deallocate(v0_diff_basis)
    deallocate(v0_nodal_coords)
    deallocate(v0_dofmap)

  end subroutine test_field_data

end module field_mod_test
