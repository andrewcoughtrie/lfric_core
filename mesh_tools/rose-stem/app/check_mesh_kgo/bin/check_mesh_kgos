#!/bin/sh
#-----------------------------------------------------------------------------
# (c) Crown copyright 2023 Met Office. All rights reserved.
# The file LICENCE, distributed with this code, contains details of the terms
# under which the code may be used.

array=($(ls ${MESH_DIR}/${MESH_FILE_PREFIX}*))

err_code=0
suffix=.nc
for test_file in ${array[@]} ; do
  partition=${test_file%${suffix}}
  partition=${partition#${MESH_DIR}/${MESH_FILE_PREFIX}}
  kgo_file=${KGO_DIR}/mesh/${TARGET_OPT}/mesh_${CONFIG}${partition}.${COMPILER}.kgo${suffix}
  echo ===============================
  echo Comparing result against KGO, Tolerance=${TOLERANCE}
  echo Result : ${test_file}
  echo KGO    : ${kgo_file}

  if [ ! -f ${kgo_file} ] ; then
    err_code=1
    echo KGO file not found: ${kgo_file} >&2
  else
    nccmp -sdfgm --Tolerance=${TOLERANCE} ${test_file} ${kgo_file}
    if [ $? != 0 ] ; then
      err_code=2
      echo error_code is ${err_code}

      updated_kgo_path=\$\{WORKING_COPY_DIR\}/${PROJECT_NAME}/kgos/mesh/${TARGET_OPT}
      updated_kgo_file=${updated_kgo_path}/mesh_${CONFIG}${partition}.${COMPILER}.kgo${suffix}

      update_script=${OUTPUT_ROOT}/kgo_task_failures
      if [ ${TARGET_OPT} == "meto-spice" ] ; then
        command="cp "
      elif [ ${TARGET_OPT} == "meto-xc40" ] ; then
        remote_host=$(rose host-select "xc")
        command="scp -q ${remote_host}:"
      else
        command="<unsupported target> "
      fi
      if [ -f ${updated_script} ] ; then
        echo "${command}${test_file} ${updated_kgo_file}" >> ${update_script}
      fi

    fi
  fi
done

if [ ${err_code} != 0 ] ; then
  exit ${err_code}
else
  exit 0
fi
