{#- This is the skeleton of the configuration feigning module used in unit -#}
{#- tests. The Jinja templating library is used to insert the actual code. -#}
!-----------------------------------------------------------------------------
! Copyright (c) 2017,  Met Office, on behalf of HMSO and Queen's Printer
! For further details please refer to the file LICENCE.original which you
! should have received as part of this distribution.
!-----------------------------------------------------------------------------
! Handles the feigning of namelists.
!
module {{modulename}}

  use constants_mod, only : {{kinds | sort | join( ', ' )}}
  use log_mod,       only : log_scratch_space, log_event, LOG_LEVEL_ERROR
  use ESMF,          only : ESMF_VM, ESMF_VMGetCurrent, ESMF_VMGet, ESMF_SUCCESS

  implicit none

  private
  public :: {{ namelists | sort | decorate( 'feign_', '_config' ) | join( ', &\n' + ' '*12 ) }}

  integer(i_native) :: local_rank = -1
  type(ESMF_VM)     :: vm
  integer(i_native), parameter :: temporary_unit = 3

contains

{%- for name in namelists | sort %}

  !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
{%-   set procedureName = 'feign_' + name + '_config' %}
  subroutine {{procedureName}}({{' '}}
{%- for param in parameters[name] %}
{%-   if not loop.first %}{{ ', &\n' }}{{ ' '*(15 + procedureName|length) }}{% endif %}
{{-   param.name }}
{%- endfor %} )

{%- set onlies = ['read_' + name + '_namelist'] %}
{%- if enumerations %}
{%-   for enum in enumerations[name]|sort -%}
{%-     do onlies.extend( ['key_from_' + enum, enum + '_from_key'] ) %}
{%-   endfor %}
{%- endif %}
{%- set moduleName = name + '_config_mod' %}

    use {{moduleName}}, only : {{onlies | join( ', &\n' + ' '*(17 + moduleName|length) )}}

    implicit none

{%- for param in parameters[name] %}
{%-   if loop.first %}{{'\n'}}{% endif %}
{%-   if param.fortranType.intrinsicType == 'character' %}
    character(*), intent(in) :: {{param.name}}
{%-   else %}
    {{param.fortranType.declaration()}}, intent(in) :: {{param.name}}
{%-   endif %}
{%- endfor %}

    integer(i_native) :: condition

    if (local_rank == -1) then
      call ESMF_VMGetCurrent( vm=vm, rc=condition )
      if (condition /= ESMF_SUCCESS) then
        write(log_scratch_space, "(A)") &
            "Failed to get VM when trying to feign {{procedureName}}"
        call log_event( log_scratch_space, LOG_LEVEL_ERROR )
      end if

      call ESMF_VMGet( vm, localPet=local_rank, rc=condition )
      if (condition /= ESMF_SUCCESS) then
        write(log_scratch_space, "(A)") &
            "Failed to query VM when trying to feign {{procedureName}}"
        call log_event( log_scratch_space, LOG_LEVEL_ERROR )
      end if
    end if

    open( temporary_unit, status='scratch', action='readwrite', &
          iostat=condition )
    if (condition /= 0) then
      write( 6, '("feign_{{name}}_config: ", I0)' ) condition
      stop
    end if

    write( temporary_unit, '("&{{name}}")' )
{%- for param in parameters[name] %}
{%-   if param.getConfigureType() == 'enumeration' %}
    write( temporary_unit, '("{{param.name}} = ''", A, "''")' ) key_from_{{param.name}}( {{param.name}} )
{%-   elif param.fortranType.intrinsicType == 'character' %}
    write( temporary_unit, '("{{param.name}} = ''", {{param.fortranType.writeFormat}}, "''")' ) {{param.name}}
{%-   else %}
    write( temporary_unit, '("{{param.name}} = ", {{param.fortranType.writeFormat}})' ) {{param.name}}
{%-   endif %}
{%- endfor %}
    write( temporary_unit, '("/")' )

    rewind(temporary_unit)
    call read_{{name}}_namelist( temporary_unit, vm, local_rank )

    close(temporary_unit, iostat=condition )
    if (condition /= 0) stop 'feign_{{name}}_config: Unable to close temporary file'

  end subroutine feign_{{name}}_config
{%- endfor %}

end module {{modulename}}
